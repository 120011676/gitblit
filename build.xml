<?xml version="1.0" encoding="UTF-8"?>
<project name="gitblit" default="main" basedir=".">

	<!-- Project Properties -->
	<property name="project.jar" value="gitblit.jar" />
	<property name="project.mainclass" value="com.gitblit.Launcher" />
	<property name="project.build.dir" value="${basedir}/build" />
	<property name="project.resources.dir" value="${basedir}/resources" />

	<loadproperties srcfile="${basedir}/build.properties" />
	
	<target name="buildinfo">
		<!-- build date -->
		<tstamp>
			<format property="gb.buildDate" pattern="yyyy-MM-dd" />
		</tstamp>
	
		<!-- extract Gitblit version number from source code -->
		<loadfile property="gb.version" srcfile="${basedir}/src/com/gitblit/Constants.java">
			<filterchain>
				<linecontains>
					<contains value="public static final String VERSION = " />
				</linecontains>
				<striplinebreaks />
				<tokenfilter>
					<replacestring from="public static final String VERSION = &quot;" to="" />
					<replacestring from="&quot;;" to="" />
					<trim />
				</tokenfilter>
			</filterchain>
		</loadfile>
	
		<!-- extract JGit version number from source code -->
		<loadfile property="jgit.version" srcfile="${basedir}/src/com/gitblit/Constants.java">
			<filterchain>
				<linecontains>
					<contains value="public static final String JGIT_VERSION = " />
				</linecontains>
				<striplinebreaks />
				<tokenfilter>
					<replacestring from="public static final String JGIT_VERSION = &quot;" to="" />
					<replacestring from="&quot;;" to="" />
					<trim />
				</tokenfilter>
			</filterchain>
		</loadfile>
		<echo>Building Gitblit ${gb.version}</echo>
		
		<property name="distribution.zipfile" value="gitblit-${gb.version}.zip" />
		<property name="distribution.warfile" value="gitblit-${gb.version}.war" />
	</target>
	
	<!-- Build Gitblit GO -->
	<target name="main" description="Compiles Gitblit from source to website" depends="buildinfo">

		<!-- copy required distribution files to project folder -->
		<copy todir="${basedir}" overwrite="false">
			<fileset dir="${basedir}/distrib">
				<include name="gitblit.properties" />
				<include name="users.properties" />
			</fileset>
		</copy>

		<!-- Compile the build tool and execute it.
			 This downloads missing compile-time dependencies from Maven. -->

		<delete dir="${project.build.dir}" />
		<mkdir dir="${project.build.dir}" />
		<javac srcdir="${basedir}/src" destdir="${project.build.dir}">
			<include name="com/gitblit/Build.java" />
			<include name="com/gitblit/BuildWebXml.java" />
			<include name="com/gitblit/Constants.java" />
			<include name="com/gitblit/utils/StringUtils.java" />			
		</javac>
		<java classpath="${project.build.dir}" classname="com.gitblit.Build" />

		<!-- Compile Project -->
		<path id="master-classpath">
			<fileset dir="${basedir}/ext">
				<include name="*.jar" />
			</fileset>
		</path>
		<javac destdir="${project.build.dir}" failonerror="false">
			<src path="${basedir}/src" />
			<classpath refid="master-classpath" />
		</javac>
		<copy todir="${project.build.dir}">
			<fileset dir="${basedir}/src" excludes="**/*.java,**/thumbs.db" />
		</copy>

		<!-- Build jar -->
		<delete file="${project.jar}" />
		<jar jarfile="${project.jar}">
			<fileset dir="${project.build.dir}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${project.resources.dir}">
				<exclude name="thumbs.db" />
			</fileset>
			<manifest>
				<attribute name="Main-Class" value="${project.mainclass}" />
			</manifest>
		</jar>

		<!-- Build Site -->
		<delete dir="${basedir}/site" />
		<mkdir dir="${basedir}/site" />
		<copy todir="${basedir}/site">
			<!-- Copy selected Gitblit resources -->
			<fileset dir="${project.resources.dir}">
				<include name="background.png" />
				<include name="gitblit.css" />
				<include name="markdown.css" />
				<include name="gitblt_25.png" />
				<include name="gitblt-favicon.png" />
				<include name="lock_go_16x16.png" />
				<include name="lock_pull_16x16.png" />
				<include name="shield_16x16.png" />
				<include name="cold_16x16.png" />
				<include name="bug_16x16.png" />
				<include name="book_16x16.png" />
				<include name="blank.png" />
			</fileset>

			<!-- Copy Doc images -->
			<fileset dir="${basedir}/docs">
				<include name="*.png" />
				<include name="*.js" />
			</fileset>
		</copy>

		<!-- Copy Fancybox -->
		<mkdir dir="${basedir}/site/fancybox" />
		<copy todir="${basedir}/site/fancybox">
			<fileset dir="${basedir}/docs/fancybox">
				<exclude name="thumbs.db" />
			</fileset>
		</copy>

		<!-- Copy google-code-prettify -->
		<mkdir dir="${basedir}/src/com/gitblit/wicket/pages/prettify" />
		<copy todir="${basedir}/site/prettify">
			<fileset dir="${basedir}/src/com/gitblit/wicket/pages/prettify">
				<exclude name="thumbs.db" />
			</fileset>
		</copy>

		<!-- Generate thumbnails of screenshots -->
		<java classpath="${project.build.dir}" classname="com.gitblit.Thumbnailer">
			<classpath refid="master-classpath" />
				
			<arg value="--sourceFolder" />
			<arg value="${basedir}/docs/screenshots" />
		
			<arg value="--destinationFolder" />
			<arg value="${basedir}/site/thumbs" />
			
			<arg value="--maximumDimension" />
			<arg value="250" />
		</java>

		<!-- Copy screenshots -->
		<mkdir dir="${basedir}/site/screenshots" />
		<copy todir="${basedir}/site/screenshots">
			<fileset dir="${basedir}/docs/screenshots">
				<include name="*.png" />
			</fileset>
		</copy>

		<!-- Build site pages -->
		<java classpath="${project.build.dir}" classname="com.gitblit.BuildSite">
			<classpath refid="master-classpath" />
			<arg value="--sourceFolder" />
			<arg value="${basedir}/docs" />

			<arg value="--outputFolder" />
			<arg value="${basedir}/site" />

			<arg value="--pageHeader" />
			<arg value="${basedir}/docs/site_header.html" />

			<arg value="--pageFooter" />
			<arg value="${basedir}/docs/site_footer.html" />

			<arg value="--alias" />
			<arg value="index=overview" />

			<arg value="--alias" />
			<arg value="properties=gitblit.properties" />

			<arg value="--substitute" />
			<arg value="%VERSION%=${gb.version}" />

			<arg value="--substitute" />
			<arg value="%DISTRIBUTION%=${distribution.zipfile}" />

			<arg value="--substitute" />
			<arg value="%BUILDDATE%=${gb.buildDate}" />

			<arg value="--substitute" />
			<arg value="%JGIT%=${jgit.version}" />

			<arg value="--load" />
			<arg value="%PROPERTIES%=${basedir}/distrib/gitblit.properties" />

		</java>

		<!-- Delete the deploy folder -->
		<delete dir="${basedir}/deploy" />

		<!-- Create deployment folder structure -->
		<mkdir dir="${basedir}/deploy" />
		<copy todir="${basedir}/deploy" file="${project.jar}" />
		<copy todir="${basedir}/deploy">
			<fileset dir="${basedir}/distrib">
				<include name="**/*" />
			</fileset>
		</copy>

		<!-- Build Deployment Docs -->
		<mkdir dir="${basedir}/deploy/docs" />
		<copy todir="${basedir}/deploy/docs">
			<!-- Copy selected Gitblit resources -->
			<fileset dir="${project.resources.dir}">
				<include name="background.png" />
				<include name="gitblit.css" />
				<include name="markdown.css" />
				<include name="gitblt_25.png" />
				<include name="gitblt-favicon.png" />
				<include name="lock_go_16x16.png" />
				<include name="lock_pull_16x16.png" />
				<include name="shield_16x16.png" />
				<include name="cold_16x16.png" />
				<include name="bug_16x16.png" />
				<include name="book_16x16.png" />
				<include name="blank.png" />
			</fileset>

			<!-- Copy Doc images -->
			<fileset dir="${basedir}/docs">
				<include name="*.png" />
			</fileset>
		</copy>

		<!-- Copy google-code-prettify -->
		<mkdir dir="${basedir}/src/com/gitblit/wicket/pages/prettify" />
		<copy todir="${basedir}/deploy/docs/prettify">
			<fileset dir="${basedir}/src/com/gitblit/wicket/pages/prettify">
				<exclude name="thumbs.db" />
			</fileset>
		</copy>

		<!-- Build deployment doc pages -->
		<java classpath="${project.build.dir}" classname="com.gitblit.BuildSite">
			<classpath refid="master-classpath" />
			<arg value="--sourceFolder" />
			<arg value="${basedir}/docs" />

			<arg value="--outputFolder" />
			<arg value="${basedir}/deploy/docs" />

			<arg value="--pageHeader" />
			<arg value="${basedir}/docs/page_header.html" />

			<arg value="--pageFooter" />
			<arg value="${basedir}/docs/page_footer.html" />

			<arg value="--skip" />
			<arg value="screenshots" />

			<arg value="--skip" />
			<arg value="releases" />

			<arg value="--alias" />
			<arg value="index=overview" />

			<arg value="--alias" />
			<arg value="properties=gitblit.properties" />

			<arg value="--substitute" />
			<arg value="%VERSION%=${gb.version}" />

			<arg value="--substitute" />
			<arg value="%DISTRIBUTION%=${distribution.zipfile}" />

			<arg value="--substitute" />
			<arg value="%BUILDDATE%=${gb.buildDate}" />

			<arg value="--substitute" />
			<arg value="%JGIT%=${jgit.version}" />

			<arg value="--load" />
			<arg value="%PROPERTIES%=${basedir}/distrib/gitblit.properties" />

		</java>
		
		<!-- Create Zip deployment -->		
		<zip destfile="${distribution.zipfile}">
			<fileset dir="${basedir}/deploy">
				<include name="**/*" />
			</fileset>
		</zip>

		<!-- Delete the deploy folder -->
		<delete dir="${basedir}/deploy" />

		<!-- Cleanup builds -->
		<delete>
			<fileset dir="${basedir}">
				<include name="${project.jar}" />
			</fileset>
		</delete>
		<!-- Cleanup -->
		<delete dir="${project.build.dir}" />
	</target>
		
	
	<!-- Build Gitblit WAR -->
	<target name="buildWAR" description="Build the Gitblit WAR" depends="buildinfo">
		<path id="master-classpath">
			<fileset dir="${basedir}/ext">
				<include name="*.jar" />
			</fileset>
		</path>
			
		<delete dir="${basedir}/war" />
		<mkdir dir="${basedir}/war/WEB-INF/lib"/>
		
		<!-- Gitblit web.xml --> 
		<java classpath="${project.build.dir}" classname="com.gitblit.BuildWebXml">
			<classpath refid="master-classpath" />
		</java>

		<!-- Gitblit resources -->
		<copy todir="${basedir}/war">
			<fileset dir="${project.resources.dir}">
				<exclude name="thumbs.db" />
			</fileset>
		</copy>
		
		<!-- Gitblit library dependencies -->
		<copy todir="${basedir}/war/WEB-INF/lib">
			<fileset dir="${basedir}/ext">
				<exclude name="*-sources.jar" />
				<exclude name="*-javadoc.jar" />
				<exclude name="jcommander*.jar" />
				<exclude name="jetty*.jar" />
				<exclude name="junit*.jar" />
				<exclude name="servlet*.jar" />
			</fileset>
		</copy>

		<!-- Gitblit classes -->
		<mkdir dir="${basedir}/war/WEB-INF/classes"/>
		<copy todir="${basedir}/war/WEB-INF/classes">
			<fileset dir="${basedir}/bin">
				<exclude name="WEB-INF/web.xml" />
				<exclude name="com/gitblit/tests/" />
				<exclude name="com/gitblit/Build*.class" />
				<exclude name="com/gitblit/GitBlitServer*.class" />
				<exclude name="com/gitblit/Launcher*.class" />
				<exclude name="com/gitblit/MakeCertificate*.class" />
				<exclude name="com/gitblit/Thumbnailer*.class" />
			</fileset>
		</copy>

		<!-- Build the WAR file -->
		<jar basedir="${basedir}/war" destfile="${distribution.warfile}" compress="true" />
	</target>

	
	<!-- Publish binaries to github -->
	<target name="publishBinaries" description="Publish the Gitblit distribution to Github">
		<!-- TODO -->
		<!-- https://github.com/oyvindkinsey/GitHubUploadTask -->
	</target>

	
	<!-- Publish site to hosting service -->
	<!-- You must add ext/commons-net-1.4.0.jar to your	ANT classpath. -->
	<target name="publishSite" description="Publish the Gitblit site to a webserver (requires ext/commons-net-1.4.0.jar)">
		<ftp server="${ftp.server}"
			userid="${ftp.user}"
			password="${ftp.password}"
			remotedir="${ftp.dir}"
			passive="true"
			verbose="yes">
		<fileset dir="${basedir}/site" />
		</ftp>
	</target>
	
</project>