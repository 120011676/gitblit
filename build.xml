<?xml version="1.0" encoding="UTF-8"?>
<project name="gitblit" default="main" basedir=".">

	<!-- Project Properties -->
	<property name="project.jar" value="gitblit.jar" />
	<property name="project.mainclass" value="com.gitblit.Launcher" />	
	<property name="project.build.dir" value="${basedir}/build" />

	<target name="main">
			
		<!-- extract version number from source code -->
		<loadfile property="gb.version" srcfile="${basedir}/src/com/gitblit/Constants.java">
			<filterchain>
				<linecontains>
		        	<contains value="public final static String VERSION = "/>
		    	</linecontains>
				<striplinebreaks/>
				<tokenfilter>				    
					<replacestring from="public final static String VERSION = &quot;" to=""/>
					<replacestring from="&quot;;" to=""/>
					<trim />
				</tokenfilter>
			</filterchain>
		</loadfile>
		<echo>Building Git:Blit ${gb.version}</echo>
		
		<!-- copy required distribution files to project folder -->
		<copy todir="${basedir}" overwrite="false">
			<fileset dir="${basedir}/distrib">
				<include name="gitblit.properties" />
				<include name="users.properties" />
			</fileset>
		</copy>
		
		<!-- Compile the build tool and execute it.
			 This downloads missing compile-time dependencies from Maven. -->

		<delete dir="${project.build.dir}" />
		<mkdir dir="${project.build.dir}" />
		<javac srcdir="${basedir}/src" destdir="${project.build.dir}">
			<include name="com/gitblit/Build.java" />
			<include name="com/gitblit/Constants.java" />
			<include name="com/gitblit/utils/StringUtils.java" />
		</javac>
		<java classpath="${project.build.dir}" classname="com.gitblit.Build" />

		<!-- Compile Project -->
		<path id="master-classpath">
			<fileset dir="${basedir}/ext">
				<include name="*.jar" />
			</fileset>
		</path>
		<javac destdir="${project.build.dir}">
			<src path="${basedir}/src" />
			<classpath refid="master-classpath" />
		</javac>
		<copy todir="${project.build.dir}">
			<fileset dir="${basedir}/src" excludes="**/*.java,**/thumbs.db" />
		</copy>

		<!-- Build jar -->
		<delete file="${project.jar}" />
		<jar jarfile="${project.jar}">
			<fileset dir="${project.build.dir}">
				<include name="**/*" />
			</fileset>
			<manifest>
				<attribute name="Main-Class" value="${project.mainclass}" />
			</manifest>
		</jar>

		<!-- Delete the deploy folder -->
		<delete dir="${basedir}/deploy" />

		<!-- Create deployment folder structure -->
		<mkdir dir="${basedir}/deploy" />
		<copy todir="${basedir}/deploy" file="${project.jar}" />
		<copy todir="${basedir}/deploy">
			<fileset dir="${basedir}/distrib">
				<include name="**/*" />
			</fileset>
		</copy>

		<!-- Create Zip deployment -->
		<property name="distribution.zipfile" value="gitblit-${gb.version}.zip" />
		<zip destfile="${distribution.zipfile}">
			<fileset dir="${basedir}/deploy">
				<include name="**/*" />
			</fileset>
		</zip>

		<!-- Delete the deploy folder -->
		<delete dir="${basedir}/deploy" />

		<!-- Cleanup builds -->
		<delete>
			<fileset dir="${basedir}">
				<include name="${project.jar}" />
			</fileset>
		</delete>
	</target>
</project>
